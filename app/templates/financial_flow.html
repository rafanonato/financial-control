{% extends "base.html" %}

{% block content %}
<style>
    .financial-flow-table {
        font-size: 0.9rem;
    }
    
    .financial-flow-table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .financial-flow-table td {
        white-space: nowrap;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .financial-flow-table td:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .financial-flow-table tr[data-type="section_header"] {
        background-color: #e9ecef;
        font-weight: bold;
    }
    
    .financial-flow-table tr[data-type="subtotal"] {
        background-color: #f8f9fa;
        font-weight: bold;
        border-top: 2px solid #dee2e6;
    }
    
    .financial-flow-table tr[data-type="highlight"] {
        background-color: #cfe2ff;
        font-weight: bold;
    }
    
    .financial-flow-table tr[data-type="total"] {
        background-color: #e2e3e5;
        font-weight: bold;
    }
    
    .financial-flow-table .text-success {
        color: #198754 !important;
    }
    
    .financial-flow-table .text-danger {
        color: #dc3545 !important;
    }
    
    .chart-container {
        height: 400px;
        margin-bottom: 2rem;
    }
    
    .btn-group .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .value-cell {
        position: relative;
    }
    
    .value-cell i {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.5;
    }
    
    .modal-body .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .filter-buttons {
        gap: 0.5rem;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Fluxo Financeiro Mensal</h2>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="exportData('excel')">
                <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-outline-primary" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label"><i class="fas fa-calendar-alt me-1"></i>Data Inicial</label>
                    <input type="month" class="form-control" id="startDate" name="startDate">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label"><i class="fas fa-calendar-alt me-1"></i>Data Final</label>
                    <input type="month" class="form-control" id="endDate" name="endDate">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="btn-group filter-buttons w-100">
                        <button type="button" class="btn btn-outline-secondary" onclick="setFilter('year')">
                            <i class="fas fa-calendar me-1"></i>Ano
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setFilter('semester1')">
                            <i class="fas fa-calendar-alt me-1"></i>1º Semestre
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setFilter('semester2')">
                            <i class="fas fa-calendar-alt me-1"></i>2º Semestre
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setFilter('quarter')">
                            <i class="fas fa-calendar-week me-1"></i>Trimestre
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Fluxo Financeiro -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover financial-flow-table" id="financialFlowTable">
                    <thead>
                        <tr>
                            <th style="min-width: 200px;">Categoria</th>
                            <!-- Meses serão inseridos dinamicamente via JavaScript -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Linhas serão inseridas dinamicamente via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Evolução Mensal</h5>
                    <div class="chart-container">
                        <div id="evolutionChart"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Composição Mensal</h5>
                    <div class="chart-container">
                        <div id="compositionChart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Detalhes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailsContent">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts específicos para a página -->
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valores monetários
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    // Função para formatar percentuais
    function formatPercentage(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'percent',
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
        }).format(value / 100);
    }

    // Função para atualizar a tabela com os dados
    function updateTable(data) {
        const table = document.getElementById('financialFlowTable');
        const tbody = table.querySelector('tbody');
        const headerRow = table.querySelector('thead tr');
        
        // Limpar conteúdo existente
        headerRow.innerHTML = '<th style="min-width: 200px;">Categoria</th>';
        tbody.innerHTML = '';
        
        // Adicionar colunas de meses
        data.months.forEach(month => {
            const th = document.createElement('th');
            const date = new Date(month + '-01');
            th.textContent = date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
            th.style.minWidth = '120px';
            headerRow.appendChild(th);
        });

        // Preencher dados
        data.rows.forEach(rowData => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-type', rowData.type);
            
            // Adicionar célula de categoria
            const tdCategory = document.createElement('td');
            tdCategory.innerHTML = `${getRowIcon(rowData.type)} ${rowData.name}`;
            tr.appendChild(tdCategory);

            // Adicionar células de valores
            rowData.values.forEach((value, index) => {
                const td = document.createElement('td');
                td.classList.add('value-cell');
                
                if (rowData.type === 'percentage') {
                    td.textContent = formatPercentage(value);
                    td.classList.add(value > 100 ? 'text-danger' : 'text-success');
                    td.innerHTML += ' <i class="fas fa-percent"></i>';
                } else if (rowData.type === 'spacer') {
                    td.innerHTML = '&nbsp;';
                } else {
                    td.textContent = formatCurrency(value);
                    if (value < 0) {
                        td.classList.add('text-danger');
                        td.innerHTML += ' <i class="fas fa-arrow-down"></i>';
                    } else if (value > 0 && !['section_header', 'subtotal'].includes(rowData.type)) {
                        td.classList.add('text-success');
                        td.innerHTML += ' <i class="fas fa-arrow-up"></i>';
                    }
                }

                // Adicionar detalhes se disponíveis
                if (rowData.details) {
                    td.setAttribute('data-has-details', 'true');
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => showDetails(rowData, index, data.months[index]));
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // Função para obter ícone baseado no tipo da linha
    function getRowIcon(type) {
        const icons = {
            'section_header': '<i class="fas fa-folder me-2"></i>',
            'income_item': '<i class="fas fa-plus-circle me-2 text-success"></i>',
            'expense_item': '<i class="fas fa-minus-circle me-2 text-danger"></i>',
            'investment': '<i class="fas fa-chart-line me-2 text-primary"></i>',
            'saving': '<i class="fas fa-piggy-bank me-2 text-info"></i>',
            'total': '<i class="fas fa-calculator me-2"></i>',
            'highlight': '<i class="fas fa-star me-2 text-warning"></i>',
            'percentage': '<i class="fas fa-percent me-2"></i>'
        };
        return icons[type] || '';
    }

    // Função para mostrar detalhes em modal
    function showDetails(rowData, monthIndex, month) {
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        const detailsContent = document.getElementById('detailsContent');
        const date = new Date(month + '-01');
        const monthName = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        
        let content = `
            <div class="alert alert-info">
                <h6 class="mb-0">
                    ${getRowIcon(rowData.type)} ${rowData.name}
                    <small class="text-muted ms-2">${monthName}</small>
                </h6>
            </div>`;
        
        if (rowData.details) {
            let total = 0;
            content += '<div class="list-group list-group-flush">';
            
            // Ordenar detalhes por valor (maior para menor)
            const sortedDetails = Object.entries(rowData.details)
                .map(([category, values]) => ({ category, value: values[monthIndex] }))
                .sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

            sortedDetails.forEach(({ category, value }) => {
                total += value;
                const valueClass = value < 0 ? 'text-danger' : 'text-success';
                const icon = value < 0 ? 'fa-arrow-down' : 'fa-arrow-up';
                
                content += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${category}</span>
                        <span class="${valueClass}">
                            ${formatCurrency(value)}
                            <i class="fas ${icon} ms-1"></i>
                        </span>
                    </div>`;
            });

            content += `
                <div class="list-group-item d-flex justify-content-between align-items-center fw-bold bg-light">
                    <span>Total</span>
                    <span class="${total < 0 ? 'text-danger' : 'text-success'}">
                        ${formatCurrency(total)}
                        <i class="fas ${total < 0 ? 'fa-arrow-down' : 'fa-arrow-up'} ms-1"></i>
                    </span>
                </div>`;
            content += '</div>';
        }

        detailsContent.innerHTML = content;
        modal.show();
    }

    // Função para criar os gráficos
    function createCharts(data) {
        // Preparar dados para os gráficos
        const months = data.months.map(m => {
            const date = new Date(m + '-01');
            return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
        });

        // Gráfico de evolução
        const evolutionTraces = [
            {
                x: months,
                y: data.rows.find(row => row.name === 'Total Entradas').values,
                type: 'scatter',
                name: 'Entradas',
                line: { color: '#198754', width: 3 },
                hovertemplate: '%{y:$.2f}<extra>Entradas</extra>'
            },
            {
                x: months,
                y: data.rows.find(row => row.name === 'Total Saídas').values,
                type: 'scatter',
                name: 'Saídas',
                line: { color: '#dc3545', width: 3 },
                hovertemplate: '%{y:$.2f}<extra>Saídas</extra>'
            },
            {
                x: months,
                y: data.rows.find(row => row.name === 'Fechamento Mensal').values,
                type: 'scatter',
                name: 'Fechamento',
                line: { color: '#0d6efd', width: 3 },
                hovertemplate: '%{y:$.2f}<extra>Fechamento</extra>'
            },
            {
                x: months,
                y: data.rows.find(row => row.name === 'Projeção Mensal (Saving+Invest)').values,
                type: 'scatter',
                name: 'Projeção',
                line: { color: '#6610f2', width: 3, dash: 'dot' },
                hovertemplate: '%{y:$.2f}<extra>Projeção</extra>'
            }
        ];

        const evolutionLayout = {
            title: 'Evolução Mensal',
            xaxis: { title: 'Mês' },
            yaxis: { 
                title: 'Valor (R$)',
                tickformat: 'R$,.2f'
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            },
            margin: { t: 30 },
            plot_bgcolor: '#ffffff',
            paper_bgcolor: '#ffffff'
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };

        Plotly.newPlot('evolutionChart', evolutionTraces, evolutionLayout, config);

        // Gráfico de composição
        const receitas = data.rows.find(row => row.name === 'SUBTOTAL RECEITAS').values;
        const investimentos = data.rows.find(row => row.name === 'SUBTOTAL INVESTIMENTOS').values;
        const despesas = data.rows.find(row => row.name === 'SUBTOTAL DESPESAS').values.map(v => -v);

        const compositionTraces = [
            {
                x: months,
                y: receitas,
                type: 'bar',
                name: 'Receitas',
                marker: { color: '#198754' },
                hovertemplate: '%{y:$.2f}<extra>Receitas</extra>'
            },
            {
                x: months,
                y: investimentos,
                type: 'bar',
                name: 'Investimentos',
                marker: { color: '#0d6efd' },
                hovertemplate: '%{y:$.2f}<extra>Investimentos</extra>'
            },
            {
                x: months,
                y: despesas,
                type: 'bar',
                name: 'Despesas',
                marker: { color: '#dc3545' },
                hovertemplate: '%{y:$.2f}<extra>Despesas</extra>'
            }
        ];

        const compositionLayout = {
            title: 'Composição Mensal',
            barmode: 'group',
            xaxis: { title: 'Mês' },
            yaxis: { 
                title: 'Valor (R$)',
                tickformat: 'R$,.2f'
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            },
            margin: { t: 30 },
            plot_bgcolor: '#ffffff',
            paper_bgcolor: '#ffffff'
        };

        Plotly.newPlot('compositionChart', compositionTraces, compositionLayout, config);
    }

    // Função para exportar dados
    window.exportData = function(format) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        let url = `/financial-flow/api/export?format=${format}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        window.location.href = url;
    }

    // Função para definir filtros rápidos
    window.setFilter = function(period) {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const quarter = Math.floor((month - 1) / 3);
        
        switch (period) {
            case 'year':
                document.getElementById('startDate').value = `${year}-01`;
                document.getElementById('endDate').value = `${year}-12`;
                break;
            case 'semester1':
                document.getElementById('startDate').value = `${year}-01`;
                document.getElementById('endDate').value = `${year}-06`;
                break;
            case 'semester2':
                document.getElementById('startDate').value = `${year}-07`;
                document.getElementById('endDate').value = `${year}-12`;
                break;
            case 'quarter':
                const startMonth = quarter * 3 + 1;
                const endMonth = startMonth + 2;
                document.getElementById('startDate').value = `${year}-${String(startMonth).padStart(2, '0')}`;
                document.getElementById('endDate').value = `${year}-${String(endMonth).padStart(2, '0')}`;
                break;
        }
        
        document.getElementById('filterForm').dispatchEvent(new Event('submit'));
    }

    // Configurar formulário de filtro
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        fetch(`/financial-flow/api?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                updateTable(data);
                createCharts(data);
            })
            .catch(error => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar os dados. Por favor, tente novamente.');
            });
    });

    // Definir filtro inicial para o ano atual
    setFilter('year');

    // Adicionar listener para redimensionamento dos gráficos
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('evolutionChart');
        Plotly.Plots.resize('compositionChart');
    });
});
</script>
{% endblock %}
{% endblock %} 